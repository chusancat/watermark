<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>云端水印相机</title>
    <style>
        body {
            margin: 0;
            font-family: sans-serif;
            background: #000;
            color: white;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #camera-container {
            position: relative;
            flex: 1;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        video,
        canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        canvas {
            display: none;
        }

        /* 隐藏canvas，仅用于处理 */

        #ui-layer {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 10;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        button {
            padding: 15px 30px;
            border-radius: 50px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        #btn-capture {
            background: white;
            color: black;
            width: 70px;
            height: 70px;
            padding: 0;
            border: 4px solid #ddd;
        }

        .options {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
        }

        #status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>

<body>

    <div id="camera-container">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <div id="status">正在获取定位...</div>

        <div id="ui-layer">
            <div class="options">
                <label><input type="checkbox" id="watermark-toggle" checked> 开启水印</label>
                <br>
                <label>分组: <select id="img-group">
                        <option value="工作">工作</option>
                        <option value="生活">生活</option>
                    </select></label>
            </div>
            <div class="controls">
                <button id="btn-capture"></button>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const statusDiv = document.getElementById('status');
        let locationData = { lat: 0, lon: 0, address: '定位中...' };

        // 1. 启动摄像头
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }, // 优先使用后置摄像头
                    audio: false
                });
                video.srcObject = stream;
            } catch (err) {
                alert('无法访问摄像头: ' + err.message);
            }
        }

        // 2. 获取地理位置
        function initGeo() {
            if (!navigator.geolocation) return statusDiv.innerText = "浏览器不支持定位";

            navigator.geolocation.getCurrentPosition(async (pos) => {
                locationData.lat = pos.coords.latitude.toFixed(6);
                locationData.lon = pos.coords.longitude.toFixed(6);

                // 反向地理编码 (使用 OpenStreetMap 免费接口，生产环境请换用高德/谷歌)
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${locationData.lat}&lon=${locationData.lon}`);
                    const data = await res.json();
                    locationData.address = data.display_name.split(',')[0]; // 简化地址
                    statusDiv.innerText = `定位: ${locationData.address}`;
                } catch (e) {
                    locationData.address = "未知地点";
                    statusDiv.innerText = "定位成功，地址获取失败";
                }
            }, err => {
                statusDiv.innerText = "定位权限被拒绝";
            });
        }

        // 3. 拍照处理
        document.getElementById('btn-capture').addEventListener('click', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');

            // 绘制当前帧
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // 如果开启水印
            if (document.getElementById('watermark-toggle').checked) {
                addWatermark(ctx, canvas.width, canvas.height);
            }

            // 压缩并上传
            canvas.toBlob(uploadImage, 'image/jpeg', 0.7); // 0.7 为压缩质量
        });

        function addWatermark(ctx, w, h) {
            const time = new Date().toLocaleString();
            const textLines = [
                `时间: ${time}`,
                `位置: ${locationData.address}`,
                `经纬: ${locationData.lat}, ${locationData.lon}`
            ];

            const fontSize = w / 25; // 动态字体大小
            ctx.font = `${fontSize}px Arial`;
            ctx.fillStyle = "white";
            ctx.shadowColor = "black";
            ctx.shadowBlur = 4;
            ctx.lineWidth = 2;

            let y = h - (textLines.length * fontSize * 1.5) - 20;
            const x = 20;

            textLines.forEach((line, index) => {
                ctx.strokeText(line, x, y + (index * fontSize * 1.5));
                ctx.fillText(line, x, y + (index * fontSize * 1.5));
            });
        }

        async function uploadImage(blob) {
            statusDiv.innerText = "正在上传...";
            const group = document.getElementById('img-group').value;

            try {
                // A. 请求后端，获取 URL 和 Headers
                const res = await fetch('/api/get-upload-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: 'photo.jpg',
                        fileType: 'image/jpeg',
                        metadata: {
                            lat: locationData.lat,
                            lon: locationData.lon,
                            // 这里的编码要和后端保持一致
                            locationName: locationData.address,
                            group: group
                        }
                    })
                });
                const { uploadURL, headers } = await res.json();

                // B. 上传到 Cloudflare R2
                // 重点：必须把后端给的 headers 传进去，缺一个都会报 403
                await fetch(uploadURL, {
                    method: 'PUT',
                    body: blob,
                    headers: headers
                });

                statusDiv.innerText = "上传成功!";
                setTimeout(() => statusDiv.innerText = `定位: ${locationData.address}`, 2000);
            } catch (err) {
                console.error(err);
                statusDiv.innerText = "上传失败";
            }
        }

        initCamera();
        initGeo();
    </script>
</body>

</html>