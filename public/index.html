<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº‘ç«¯æ°´å°ç›¸æœº</title>
    <style>
        body {
            margin: 0;
            font-family: sans-serif;
            background: #000;
            color: white;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        #camera-container {
            position: relative;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        canvas {
            display: none;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        #status {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            z-index: 20;
            backdrop-filter: blur(4px);
        }

        /* åº•éƒ¨æ“ä½œåŒº */
        #ui-layer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px 20px 40px 20px;
            /* åº•éƒ¨ç•™å¤šç‚¹ç©ºéš™é€‚é…å…¨é¢å± */
            box-sizing: border-box;
            z-index: 10;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* é€‰é¡¹æ  */
        .options {
            display: flex;
            justify-content: center;
            gap: 15px;
            font-size: 14px;
            text-shadow: 0 1px 2px black;
        }

        .options label {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* æŒ‰é’®æ§åˆ¶æ  - å…³é”®ï¼šä½¿ç”¨ Flex å¸ƒå±€å®ç°å±…ä¸­ */
        .controls {
            display: flex;
            justify-content: center;
            /* å±…ä¸­æ‹ç…§é”® */
            align-items: center;
            position: relative;
            /* ä¸ºç»å¯¹å®šä½çš„æŒ‰é’®æä¾›å‚è€ƒ */
            height: 80px;
        }

        /* æ‹ç…§å¤§æŒ‰é’® */
        #btn-capture {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: 4px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: transform 0.1s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        #btn-capture:active {
            transform: scale(0.9);
            background: white;
        }

        /* åå°è·³è½¬æŒ‰é’® (å®šä½åˆ°å³ä¾§) */
        #btn-gallery {
            position: absolute;
            right: 20px;
            color: white;
            text-decoration: none;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 13px;
            backdrop-filter: blur(5px);
        }
    </style>
</head>

<body>

    <div id="camera-container">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <div id="status">æ­£åœ¨è·å–å®šä½...</div>

        <div id="ui-layer">
            <div class="options">
                <label><input type="checkbox" id="watermark-toggle" checked> æ°´å°</label>
                <label>åˆ†ç»„: <select id="img-group" style="border-radius:4px; padding:2px;">
                        <option value="å·¥ä½œ">å·¥ä½œ</option>
                        <option value="ä¿¡æ¯">ä¿¡æ¯</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select></label>
            </div>

            <div class="controls">
                <button id="btn-capture"></button>

                <a href="/admin" id="btn-gallery">ğŸ“‚ ç›¸å†Œ</a>
            </div>
        </div>

        <script>
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const statusDiv = document.getElementById('status');
            let locationData = { lat: 0, lon: 0, address: 'å®šä½ä¸­...' };

            // 1. å¯åŠ¨æ‘„åƒå¤´
            async function initCamera() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment' }, // ä¼˜å…ˆä½¿ç”¨åç½®æ‘„åƒå¤´
                        audio: false
                    });
                    video.srcObject = stream;
                } catch (err) {
                    alert('æ— æ³•è®¿é—®æ‘„åƒå¤´: ' + err.message);
                }
            }

            // 2. è·å–åœ°ç†ä½ç½®
            function initGeo() {
                if (!navigator.geolocation) return statusDiv.innerText = "æµè§ˆå™¨ä¸æ”¯æŒå®šä½";

                navigator.geolocation.getCurrentPosition(async (pos) => {
                    locationData.lat = pos.coords.latitude.toFixed(6);
                    locationData.lon = pos.coords.longitude.toFixed(6);

                    // åå‘åœ°ç†ç¼–ç  (ä½¿ç”¨ OpenStreetMap å…è´¹æ¥å£ï¼Œç”Ÿäº§ç¯å¢ƒè¯·æ¢ç”¨é«˜å¾·/è°·æ­Œ)
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${locationData.lat}&lon=${locationData.lon}`);
                        const data = await res.json();
                        locationData.address = data.display_name.split(',')[0]; // ç®€åŒ–åœ°å€
                        statusDiv.innerText = `å®šä½: ${locationData.address}`;
                    } catch (e) {
                        locationData.address = "æœªçŸ¥åœ°ç‚¹";
                        statusDiv.innerText = "å®šä½æˆåŠŸï¼Œåœ°å€è·å–å¤±è´¥";
                    }
                }, err => {
                    statusDiv.innerText = "å®šä½æƒé™è¢«æ‹’ç»";
                });
            }

            // 3. æ‹ç…§å¤„ç†
            document.getElementById('btn-capture').addEventListener('click', () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');

                // ç»˜åˆ¶å½“å‰å¸§
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // å¦‚æœå¼€å¯æ°´å°
                if (document.getElementById('watermark-toggle').checked) {
                    addWatermark(ctx, canvas.width, canvas.height);
                }

                // å‹ç¼©å¹¶ä¸Šä¼ 
                canvas.toBlob(uploadImage, 'image/jpeg', 0.7); // 0.7 ä¸ºå‹ç¼©è´¨é‡
            });

            function addWatermark(ctx, w, h) {
                const time = new Date().toLocaleString();
                const textLines = [
                    `æ—¶é—´: ${time}`,
                    `ä½ç½®: ${locationData.address}`,
                    `ç»çº¬: ${locationData.lat}, ${locationData.lon}`
                ];

                const fontSize = w / 25; // åŠ¨æ€å­—ä½“å¤§å°
                ctx.font = `${fontSize}px Arial`;
                ctx.fillStyle = "white";
                ctx.shadowColor = "black";
                ctx.shadowBlur = 4;
                ctx.lineWidth = 2;

                let y = h - (textLines.length * fontSize * 1.5) - 20;
                const x = 20;

                textLines.forEach((line, index) => {
                    ctx.strokeText(line, x, y + (index * fontSize * 1.5));
                    ctx.fillText(line, x, y + (index * fontSize * 1.5));
                });
            }

            async function uploadImage(blob) {
                statusDiv.innerText = "æ­£åœ¨ä¸Šä¼ ...";
                const group = document.getElementById('img-group').value;

                try {
                    // A. è¯·æ±‚åç«¯ï¼Œè·å– URL å’Œ Headers
                    const res = await fetch('/api/get-upload-url', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            filename: 'photo.jpg',
                            fileType: 'image/jpeg',
                            metadata: {
                                lat: locationData.lat,
                                lon: locationData.lon,
                                // è¿™é‡Œçš„ç¼–ç è¦å’Œåç«¯ä¿æŒä¸€è‡´
                                locationName: locationData.address,
                                group: group
                            }
                        })
                    });
                    const { uploadURL, headers } = await res.json();

                    // B. ä¸Šä¼ åˆ° Cloudflare R2
                    // é‡ç‚¹ï¼šå¿…é¡»æŠŠåç«¯ç»™çš„ headers ä¼ è¿›å»ï¼Œç¼ºä¸€ä¸ªéƒ½ä¼šæŠ¥ 403
                    await fetch(uploadURL, {
                        method: 'PUT',
                        body: blob,
                        headers: headers
                    });

                    statusDiv.innerText = "ä¸Šä¼ æˆåŠŸ!";
                    setTimeout(() => statusDiv.innerText = `å®šä½: ${locationData.address}`, 2000);
                } catch (err) {
                    console.error(err);
                    statusDiv.innerText = "ä¸Šä¼ å¤±è´¥";
                }
            }

            initCamera();
            initGeo();
        </script>
</body>

</html>